---
tags:
  - 原理
created: 2023-09-10 17:37
chapter: DAX进阶
keyword: 
des: 
return: 
import: 5
hard: 2
aliases: []
done:
---
## DAX引擎
- 公式引擎 （ Formula Engine ，简称 FE ），该引擎用于处理请求、生成和执行查询计划。
- 存储引擎 （ Storage Engine ，简称 SE），该引擎负责从表格模型检索数据，以响应公式引擎发出的请求。存储引擎有两种实现方式：
	- VertiPaq ：它负责承载从数据源定期刷新到内存中的数据副本。
	- DirectQuery： 它将每个请求的查询直接转发到原始数据源。（根据对接引擎的不同，下发的查询可能是 SQL 查询、DAX 查询或者 MDX 查询），DirectQuery 不会创建其他数据副本。
![](https://s2.loli.net/2023/09/10/xWRiVFaveLnZsub.png)

## 公式引擎
公式引擎是DAX引擎的核心，它将DAX或MDX查询转换为查询计划（Query Plan）,其内容是将要执行的物理步骤的列表。Tabular 的存储引擎并不知道发送它的查询从哪里来。
查询计划中的每个步骤都对应于公式引擎执行的特定操作。公式引擎的典型运算符包括表之间的联接、具有复杂条件的筛选、聚合和查找。这些运算符通常需要来自数据模型中列的数据。在这些情况下，公式引擎向存储引擎发送一个请求，存储引擎通过返回数据缓存来响应请求。数据缓存是由存储引擎创建并由公式引擎读取的临时存储区域。
>注意： 数据缓存不会被压缩，无论来自哪个存储引擎，数据缓存都是以未压缩的格式存储普通内存表。

公式引擎始终使用存储引擎返回的数据缓存，或使用其他公式引擎运算符计算的数据结构。公式引擎操作的结果不会在不同的执行之间（甚至在同一个会话中）持久存在于内存中。另一方面，数据缓存保存在内存中，可以在后续查询中重用。公式引擎没有缓存系统，无法在不同查询之间重用结果。**DAX 完全依赖于存储引擎的缓存功能。

**公式引擎是单线程的**。这意味着在公式引擎中执行的任何操作都只使用一个线程和一个核心，不管有多少个核心可用。公式引擎按顺序向存储引擎发送请求，一次一个查询。只有在对存储引擎的每个请求中才有一定程度的并行性，存储引擎具有不同的体系结构，并且可以利用多个可用核心。
## 存储引擎
存储引擎的任务是扫描 Tabular 数据库并生成公式引擎所需的数据缓存。存储引擎独立于 DAX。例如，使用 DirectQuery 对接 SQL Server 时，将使用 SQL 作为存储引擎。SQL 比 DAX 早得多。尽管看起来很奇怪，但 Tabular 的内部存储引擎（称为 VertiPaq）也独立于 DAX。
开发人员可以使用以下三个选项之一来定义每个表使用的存储引擎
- **Import**：也称为内存模式或 VertiPaq。数据由 VertiPaq 引擎存储，在数据刷新时，从数据源复制和重组数据。
- **DirectQuery**：在查询时从数据源读取表的内容，在数据刷新期间不会存储在内存中。
- **Dual**：可以在 VertiPaq 和 DirectQuery 中查询该表。在数据刷新期间，表将加载到内存中，但在查询时，还可以以 DirectQuery 模式读取包含最新信息的数据。

**存储引擎具有并行响应能力**。然而，它接收来自公式引擎的请求，该引擎会同步发送它们。因此，公式引擎等待一个存储引擎查询完成，然后再发送下一个查询。**由于公式引擎缺乏并行性，存储引擎中的并行性可能会降低**。

### VertiPaq

### DirectQuery


## 公式引擎VS存储引擎
|   |   |   |
|---|---|---|
|**Basis  基础**|**FE**|SE|
|定义|查询引擎的高级执行单元称为公式引擎|负责数据检索的引擎称为存储引擎|
|名称| <br>公式引擎称为 DirectQuery|  <br>该存储引擎称为 VertiPaq（也称为 xVelocity）|
|表达类型| <br>公式引擎是一个复杂的表达式| <br>存储引擎是一个简单的表达|
|使用的数据|它使用 SE 的未压缩数据缓存|它扫描内存中的压缩数据|
|多线程|单线程的|多线程，具有并行计算的能力|
|缓存结果| <br>不会提供任何缓存结果| 提供了缓存结果|
|优化|<br>公式引擎针对复杂性进行了优化|存储引擎针对速度进行了优化|
|速度|公式引擎速度很慢|存储引擎速度很快。|

## 参考
https://www.sqlbi.com/articles/formula-engine-and-storage-engine-in-dax/
https://edu4sure.com/dax-engines
https://www.sqlbi.com/whitepapers/directquery-in-analysis-services-2016/